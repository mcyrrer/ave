

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Services &mdash; AVE User&#39;s Guide  documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="AVE User&#39;s Guide  documentation" href="../index.html" />
    <link rel="up" title="System Documentation" href="index.html" />
    <link rel="next" title="Frequently Asked Questions" href="../faq/index.html" />
    <link rel="prev" title="Upstart Integration" href="upstart_integration.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../faq/index.html" title="Frequently Asked Questions"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="upstart_integration.html" title="Upstart Integration"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">AVE User&#39;s Guide  documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">System Documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="services">
<h1>Services<a class="headerlink" href="#services" title="Permalink to this headline">¶</a></h1>
<p>All AVE services support starting, restarting and stopping. In most cases a
restart cannot be detected by currently executing test jobs. (The exception is
the ADB server which will tear down any TCP port forwarding rules when it is
restarted.)</p>
<p>All services implement a common CLI to support these operations:</p>
<div class="highlight-python"><pre>ave-&lt;service&gt; --start [--force]
ave-&lt;service&gt; --restart
ave-&lt;service&gt; --stop</pre>
</div>
<p>The <tt class="docutils literal"><span class="pre">--force</span></tt> flag should only be used from <em>Upstart</em> integration as it will
delete any found PID file for the service without checking for actual processes.</p>
<div class="section" id="starting">
<h2>Starting<a class="headerlink" href="#starting" title="Permalink to this headline">¶</a></h2>
<p>Typical steps performed by the executable:</p>
<blockquote>
<div><ul class="simple">
<li>Use <tt class="docutils literal"><span class="pre">ave.config.load_etc()</span></tt> to find the ID and home directory of the user
selected to run AVE services.</li>
<li>Use <tt class="docutils literal"><span class="pre">ave.persona.become_user()</span></tt> to demote the effective user ID to that of
the selected user. Services should normally not run as <tt class="docutils literal"><span class="pre">root</span></tt>.</li>
<li>Create an instance of the service&#8217;s main Python class and daemonize it.</li>
<li>Create the PID file <tt class="docutils literal"><span class="pre">/var/tmp/ave-&lt;service&gt;.pid</span></tt>.</li>
<li>The service uses <tt class="docutils literal"><span class="pre">ave.config.load_authkeys()</span></tt> to read the <tt class="docutils literal"><span class="pre">admin</span></tt> key
from <tt class="docutils literal"><span class="pre">.ave/config/authkeys.json</span></tt> and requires that calls to administrative
functions are made by clients that know this value.</li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The use of authentication keys for administration is <em>not</em> a security
feature. It is only meant to avoid accidental use of admin functionality
from regular test jobs.</p>
</div>
</div>
<div class="section" id="restarting">
<h2>Restarting<a class="headerlink" href="#restarting" title="Permalink to this headline">¶</a></h2>
<p>Currently executing test jobs must not be affected by restarts, which makes this
a complex operation. The general idea is to</p>
<blockquote>
<div><ul class="simple">
<li>Use <tt class="docutils literal"><span class="pre">ave.config.load_authkeys()</span></tt> to load the <tt class="docutils literal"><span class="pre">admin</span></tt> authentication key
from <tt class="docutils literal"><span class="pre">.ave/config/authkeys.json</span></tt>.</li>
<li>Find the currently executing instance and connect to it with the <tt class="docutils literal"><span class="pre">admin</span></tt>
authentication key.</li>
<li>Tell the running instance to dump its internal state and to stop accepting
new clients.</li>
<li>Create a new instance of the service and feed the internal state to it.</li>
<li>Tell the running service that it may quit as soon as all of its regular
clients have disconnected.</li>
<li>Daemonize the new instance.</li>
<li>Replace the PID file.</li>
</ul>
</div></blockquote>
<p>This means that two instances will be executing until the old instance has lost
all of its clients. New clients can only connect to the new instance because the
old instance no longer has a listening socket.</p>
<div class="section" id="rationale">
<h3>Rationale<a class="headerlink" href="#rationale" title="Permalink to this headline">¶</a></h3>
<p>The restart behavior is not typical for UNIX daemons and is not supported with
convenience features in any of the major <tt class="docutils literal"><span class="pre">init</span></tt> implementations. Some AVE
services are very complicated to restart seamlessly. Why bother?</p>
<blockquote>
<div><ul class="simple">
<li>The lab owner should be able to update an AVE installation without having to
plan for maintenance downtime.</li>
<li>Some tests can conceivably run for days or even weeks (power measurements
and aging tests come to mind) and would be costly to evict.</li>
<li>Scheduler complexity would increase a lot if it was necessary to handle job
errors that stem from service restarts (and this assumes that all jobs report
this error correctly). There may be many schedulers but only one framework
so it is cheapest and most robust to solve problem in the framework.</li>
</ul>
</div></blockquote>
</div>
</div>
<div class="section" id="stopping">
<h2>Stopping<a class="headerlink" href="#stopping" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul class="simple">
<li>Use <tt class="docutils literal"><span class="pre">ave.config.load_authkeys()</span></tt> to load the <tt class="docutils literal"><span class="pre">admin</span></tt> authentication key
from <tt class="docutils literal"><span class="pre">.ave/config/authkeys.json</span></tt>.</li>
<li>Find the currently executing instance and connect to it with the <tt class="docutils literal"><span class="pre">admin</span></tt>
authentication key.</li>
<li>Tell the service to evict all clients and terminate itself.</li>
<li>Delete the PID file.</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="systemic-uses">
<h2>Systemic Uses<a class="headerlink" href="#systemic-uses" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul class="simple">
<li><em>Upstart</em> scripts use <tt class="docutils literal"><span class="pre">ave-&lt;service&gt;</span> <span class="pre">--start</span> <span class="pre">--force</span></tt> to start services
when the PC boots.</li>
<li>Debian package <tt class="docutils literal"><span class="pre">postinst</span></tt> scripts use the (re)start functionality when
packages are configured after installation. So, installing a new version of
an AVE component automatically restarts it (or starts it if it wasn&#8217;t already
running).</li>
<li>Programmatic use from lab supervision tools.</li>
<li>Manual use by the lab owner.</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="notes">
<h2>Notes<a class="headerlink" href="#notes" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul class="simple">
<li>The ADB server is never restarted automatically by AVE because it is not
possible to hide this event from currently executing test jobs. The lab owner
has to do this manually in the event that it is needed.</li>
<li>There is no AVE service to manage the life cycle of FG3. The lab owner has to
start and stop <tt class="docutils literal"><span class="pre">fg3console</span></tt> as needed.</li>
</ul>
</div></blockquote>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Services</a><ul>
<li><a class="reference internal" href="#starting">Starting</a></li>
<li><a class="reference internal" href="#restarting">Restarting</a><ul>
<li><a class="reference internal" href="#rationale">Rationale</a></li>
</ul>
</li>
<li><a class="reference internal" href="#stopping">Stopping</a></li>
<li><a class="reference internal" href="#systemic-uses">Systemic Uses</a></li>
<li><a class="reference internal" href="#notes">Notes</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="upstart_integration.html"
                        title="previous chapter">Upstart Integration</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../faq/index.html"
                        title="next chapter">Frequently Asked Questions</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/system/services.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../faq/index.html" title="Frequently Asked Questions"
             >next</a> |</li>
        <li class="right" >
          <a href="upstart_integration.html" title="Upstart Integration"
             >previous</a> |</li>
        <li><a href="../index.html">AVE User&#39;s Guide  documentation</a> &raquo;</li>
          <li><a href="index.html" >System Documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013-2014, Sony Mobile Communications Inc..
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>